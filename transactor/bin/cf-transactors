#!/bin/bash

STACK_NAME="WBTransactor"
DATOMIC_VERSION="0.9.5385"
TEMPLATE_DIR="${HOME}/git/wormbase-architecture/transactor/config"
TEMPLATE_PATH="${TEMPLATE_DIR}/wb-cf-ensured.json"
TMP_LK_PATH="/tmp/dp-wb-license.key"

AWS_PROFILE="$1"
OP="$2"
WS_RELEASE="$3"
DESIRED_CAPACITY="$4"

WB_AWS="aws --profile=${AWS_PROFILE}"

USAGE="$0 <AWS_PROFILE[string]> <ACTION[string:create|update]> <WS_RELEASE[string]> <DESIRED_CAPACITY[number]>"

REQUIRED=( "${AWS_PROFILE}" "${OP}" "${WS_RELEASE}" "${DESIRED_CAPACITY}")

n_required=${#REQUIRED[@]}
n_provided=0
for (( i=0; i<$n_required; i++))
do
    if [ ! -z $REQUIRED[$i] ]; then
	let n_provided+=1
    fi
done

if [ $n_provided -ne 4 ]
then
    echo "Error: expected 4 arguments, got $n_provided"
    echo "${USAGE}"
    exit 1
fi

if !([ "${OP}" == "create" ] || [ "${OP}" == "update" ])
then
    echo "${USAGE}"
    echo "${OP}"
    exit 2
fi

aws --profile "${AWS_PROFILE}" \
    s3 cp s3://wormbase/datomic-pro/license.key "${TMP_LK_PATH}"

if [ $? -ne 0 ]; then
    echo "Failed to download WormBase datomic-pro license key from S3"
    exit 3
fi

LICENSE_KEY_CONTENTS=`cat ${TMP_LK_PATH}`

rm "${TMP_LK_PATH}"


# Array of Parameters for CloudFormation template's Resources
CF_PARAMS=( "ParameterKey=UserName,ParameterValue=${AWS_PROFILE}"\ \
"ParameterKey=DatomicVersion,ParameterValue=${DATOMIC_VERSION}"\ \
"ParameterKey=DatomicLicenseKey,ParameterValue=${LICENSE_KEY_CONTENTS}"\ \
"ParameterKey=WormbaseDataVersion,ParameterValue=${WS_RELEASE}"\ \
"ParameterKey=AutoScalingDesiredCapacity,\
ParameterValue=${DESIRED_CAPACITY}" )


validation_errs_file="/tmp/$$.validation.errors"

aws --profile "${AWS_PROFILE}" \
    cloudformation validate-template \
    --template-body "file://${TEMPLATE_PATH}" \
   >> "${validation_errs_file}" 2>&1

valid=$?
validation_errs=`cat ${validation_errs_file}`
rm "${validation_errs_file}"

if [ $valid -ne 0 ];
then
    echo -e "${validation_errs_file}"
    exit 3
fi

aws --profile "${AWS_PROFILE}" \
    cloudformation "${OP}-stack" \
    --stack-name "${STACK_NAME}" \
    --template-body "file://${TEMPLATE_PATH}" \
    --parameters ${CF_PARAMS}
